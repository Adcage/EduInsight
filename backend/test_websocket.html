<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocketæµ‹è¯•é¡µé¢</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .connected {
            background-color: #d4edda;
            color: #155724;
        }
        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
        .log {
            background-color: #f8f9fa;
            padding: 15px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
            margin: 20px 0;
        }
        .log-item {
            padding: 5px;
            margin: 5px 0;
            border-bottom: 1px solid #e9ecef;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        input, textarea {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ced4da;
            border-radius: 4px;
        }
        .section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <h1>ğŸš€ WebSocketæµ‹è¯•é¡µé¢</h1>
    
    <div id="status" class="status disconnected">
        çŠ¶æ€: æœªè¿æ¥
    </div>
    
    <div class="section">
        <h2>1. è¿æ¥ç®¡ç†</h2>
        <button onclick="connect()">è¿æ¥WebSocket</button>
        <button onclick="disconnect()">æ–­å¼€è¿æ¥</button>
        <button onclick="ping()">å‘é€Ping</button>
    </div>
    
    <div class="section">
        <h2>2. åŠ å…¥/ç¦»å¼€è¯¾ç¨‹</h2>
        <input type="number" id="courseId" placeholder="è¯¾ç¨‹ID" value="1">
        <input type="number" id="userId" placeholder="ç”¨æˆ·ID" value="1">
        <input type="text" id="userName" placeholder="ç”¨æˆ·å" value="æµ‹è¯•ç”¨æˆ·">
        <br>
        <button onclick="joinCourse()">åŠ å…¥è¯¾ç¨‹</button>
        <button onclick="leaveCourse()">ç¦»å¼€è¯¾ç¨‹</button>
        <button onclick="getRoomInfo()">è·å–æˆ¿é—´ä¿¡æ¯</button>
    </div>
    
    <div class="section">
        <h2>3. å‘é€å¼¹å¹•</h2>
        <textarea id="barrageContent" placeholder="å¼¹å¹•å†…å®¹" rows="3">è¿™æ˜¯ä¸€æ¡æµ‹è¯•å¼¹å¹•ï¼</textarea>
        <button onclick="sendBarrage()">å‘é€å¼¹å¹•</button>
    </div>
    
    <div class="section">
        <h2>4. äº‹ä»¶æ—¥å¿—</h2>
        <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        <div id="log" class="log"></div>
    </div>
    
    <script>
        let socket = null;
        
        function addLog(message, type = 'info') {
            const log = document.getElementById('log');
            const item = document.createElement('div');
            item.className = 'log-item';
            const timestamp = new Date().toLocaleTimeString();
            item.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            log.appendChild(item);
            log.scrollTop = log.scrollHeight;
        }
        
        function updateStatus(connected) {
            const status = document.getElementById('status');
            if (connected) {
                status.className = 'status connected';
                status.textContent = 'çŠ¶æ€: å·²è¿æ¥ âœ…';
            } else {
                status.className = 'status disconnected';
                status.textContent = 'çŠ¶æ€: æœªè¿æ¥ âŒ';
            }
        }
        
        function connect() {
            if (socket && socket.connected) {
                addLog('âš ï¸ å·²ç»è¿æ¥ï¼Œæ— éœ€é‡å¤è¿æ¥');
                return;
            }
            
            addLog('ğŸ”„ æ­£åœ¨è¿æ¥WebSocket...');
            
            socket = io('http://localhost:5030', {
                transports: ['websocket', 'polling']
            });
            
            // è¿æ¥æˆåŠŸ
            socket.on('connect', () => {
                addLog('âœ… WebSocketè¿æ¥æˆåŠŸï¼');
                updateStatus(true);
            });
            
            // è¿æ¥å¤±è´¥
            socket.on('connect_error', (error) => {
                addLog(`âŒ è¿æ¥å¤±è´¥: ${error.message}`);
                updateStatus(false);
            });
            
            // æ–­å¼€è¿æ¥
            socket.on('disconnect', () => {
                addLog('âš ï¸ WebSocketå·²æ–­å¼€');
                updateStatus(false);
            });
            
            // æœåŠ¡å™¨ç¡®è®¤è¿æ¥
            socket.on('connected', (data) => {
                addLog(`ğŸ“¡ æœåŠ¡å™¨å“åº”: ${data.message}`);
                addLog(`ğŸ†” å®¢æˆ·ç«¯ID: ${data.client_id}`);
            });
            
            // Pongå“åº”
            socket.on('pong', (data) => {
                addLog(`ğŸ“ æ”¶åˆ°Pong: ${data.message}`);
            });
            
            // åŠ å…¥è¯¾ç¨‹æˆåŠŸ
            socket.on('joined_course', (data) => {
                addLog(`âœ… ${data.message} (æˆ¿é—´: ${data.room})`);
            });
            
            // ç¦»å¼€è¯¾ç¨‹æˆåŠŸ
            socket.on('left_course', (data) => {
                addLog(`ğŸ‘‹ ${data.message}`);
            });
            
            // ç”¨æˆ·åŠ å…¥é€šçŸ¥
            socket.on('user_joined', (data) => {
                addLog(`ğŸ‘¤ ${data.message}`);
            });
            
            // ç”¨æˆ·ç¦»å¼€é€šçŸ¥
            socket.on('user_left', (data) => {
                addLog(`ğŸ‘¤ ${data.message}`);
            });
            
            // æ–°å¼¹å¹•
            socket.on('new_barrage', (data) => {
                addLog(`ğŸ’¬ æ”¶åˆ°æ–°å¼¹å¹•: ${data.barrage.content}`);
            });
            
            // æ–°æŠ•ç¥¨
            socket.on('new_poll', (data) => {
                addLog(`ğŸ“Š æ”¶åˆ°æ–°æŠ•ç¥¨: ${data.poll.title}`);
            });
            
            // æŠ•ç¥¨ç»“æœæ›´æ–°
            socket.on('poll_results_updated', (data) => {
                addLog(`ğŸ“Š æŠ•ç¥¨ç»“æœæ›´æ–°: Poll ${data.poll_id}`);
            });
            
            // æ–°é—®é¢˜
            socket.on('new_question', (data) => {
                addLog(`â“ æ”¶åˆ°æ–°é—®é¢˜: ${data.question.content}`);
            });
            
            // æ–°å›ç­”
            socket.on('new_answer', (data) => {
                addLog(`ğŸ’¡ æ”¶åˆ°æ–°å›ç­”: ${data.answer.content}`);
            });
            
            // æˆ¿é—´ä¿¡æ¯
            socket.on('room_info', (data) => {
                addLog(`ğŸ  æˆ¿é—´ä¿¡æ¯: ${JSON.stringify(data)}`);
            });
            
            // é”™è¯¯
            socket.on('error', (data) => {
                addLog(`âŒ é”™è¯¯: ${data.message}`);
            });
        }
        
        function disconnect() {
            if (socket) {
                socket.disconnect();
                addLog('ğŸ‘‹ å·²æ–­å¼€è¿æ¥');
                updateStatus(false);
            }
        }
        
        function ping() {
            if (!socket || !socket.connected) {
                addLog('âŒ è¯·å…ˆè¿æ¥WebSocket');
                return;
            }
            addLog('ğŸ“ å‘é€Ping...');
            socket.emit('ping');
        }
        
        function joinCourse() {
            if (!socket || !socket.connected) {
                addLog('âŒ è¯·å…ˆè¿æ¥WebSocket');
                return;
            }
            
            const courseId = parseInt(document.getElementById('courseId').value);
            const userId = parseInt(document.getElementById('userId').value);
            const userName = document.getElementById('userName').value;
            
            addLog(`ğŸšª æ­£åœ¨åŠ å…¥è¯¾ç¨‹ ${courseId}...`);
            socket.emit('join_course', {
                course_id: courseId,
                user_id: userId,
                user_name: userName
            });
        }
        
        function leaveCourse() {
            if (!socket || !socket.connected) {
                addLog('âŒ è¯·å…ˆè¿æ¥WebSocket');
                return;
            }
            
            const courseId = parseInt(document.getElementById('courseId').value);
            const userId = parseInt(document.getElementById('userId').value);
            const userName = document.getElementById('userName').value;
            
            addLog(`ğŸšª æ­£åœ¨ç¦»å¼€è¯¾ç¨‹ ${courseId}...`);
            socket.emit('leave_course', {
                course_id: courseId,
                user_id: userId,
                user_name: userName
            });
        }
        
        function getRoomInfo() {
            if (!socket || !socket.connected) {
                addLog('âŒ è¯·å…ˆè¿æ¥WebSocket');
                return;
            }
            
            const courseId = parseInt(document.getElementById('courseId').value);
            addLog('ğŸ” è·å–æˆ¿é—´ä¿¡æ¯...');
            socket.emit('get_room_info', {
                course_id: courseId
            });
        }
        
        function sendBarrage() {
            if (!socket || !socket.connected) {
                addLog('âŒ è¯·å…ˆè¿æ¥WebSocket');
                return;
            }
            
            const courseId = parseInt(document.getElementById('courseId').value);
            const userId = parseInt(document.getElementById('userId').value);
            const content = document.getElementById('barrageContent').value;
            
            if (!content.trim()) {
                addLog('âŒ å¼¹å¹•å†…å®¹ä¸èƒ½ä¸ºç©º');
                return;
            }
            
            addLog(`ğŸ’¬ å‘é€å¼¹å¹•: ${content}`);
            socket.emit('barrage_sent', {
                course_id: courseId,
                barrage: {
                    id: Date.now(),
                    content: content,
                    user_id: userId,
                    user_name: document.getElementById('userName').value,
                    is_anonymous: false,
                    created_at: new Date().toISOString()
                }
            });
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
            addLog('ğŸ—‘ï¸ æ—¥å¿—å·²æ¸…ç©º');
        }
        
        // é¡µé¢åŠ è½½æ—¶çš„æç¤º
        addLog('ğŸ‘‹ æ¬¢è¿ä½¿ç”¨WebSocketæµ‹è¯•é¡µé¢ï¼');
        addLog('ğŸ’¡ è¯·å…ˆç‚¹å‡»"è¿æ¥WebSocket"æŒ‰é’®');
    </script>
</body>
</html>
