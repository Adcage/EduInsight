# 用户认证与权限管理使用指南

## 概述

本文档介绍了教师智能助手系统的用户认证与权限管理功能的使用方法。系统支持多角色登录、注册、权限控制，基于Flask Session进行用户认证。

## 功能特性

### 🔐 认证功能
- **多角色注册**：支持管理员、教师、学生三种角色注册
- **多方式登录**：支持邮箱、用户名、工号/学号登录
- **Session认证**：基于Flask Session的安全认证机制
- **密码加密**：使用Werkzeug安全哈希存储密码

### 👥 权限管理
- **角色权限**：不同角色拥有不同的系统权限
- **装饰器控制**：基于装饰器的权限验证
- **细粒度权限**：支持资源级别的权限控制

### 🛡️ 安全特性
- **密码验证**：强密码策略和验证
- **账户状态管理**：支持账户激活/停用
- **操作日志**：记录用户操作日志

## 用户角色与权限

### 角色定义

| 角色 | 描述 | 权限范围 |
|------|------|----------|
| **admin** | 系统管理员 | 拥有所有权限，可管理所有用户和系统设置 |
| **teacher** | 教师 | 可管理课程、资料、考勤、成绩等教学相关功能 |
| **student** | 学生 | 可查看课程、资料、成绩，参与考勤和课堂互动 |

### 权限矩阵

| 功能模块 | 管理员 | 教师 | 学生 |
|----------|--------|------|------|
| 用户管理 | ✅ 完全控制 | ❌ | ❌ |
| 资料管理 | ✅ 完全控制 | ✅ 创建/编辑/删除 | ✅ 查看/下载 |
| 课程管理 | ✅ 完全控制 | ✅ 创建/编辑 | ✅ 查看 |
| 考勤管理 | ✅ 完全控制 | ✅ 创建/管理 | ✅ 签到/查看 |
| 成绩管理 | ✅ 完全控制 | ✅ 录入/编辑 | ✅ 查看自己的成绩 |
| 课堂互动 | ✅ 完全控制 | ✅ 创建/管理 | ✅ 参与互动 |

## API接口使用

### 认证相关接口

#### 1. 用户注册
```http
POST /api/v1/auth/register
Content-Type: application/json

{
    "username": "zhangsan",
    "user_code": "2024001",
    "password": "password123",
    "email": "zhangsan@example.com",
    "real_name": "张三",
    "role": "student",
    "phone": "13800138000",
    "class_id": 1
}
```

**响应示例：**
```json
{
    "message": "注册成功",
    "user": {
        "id": 1,
        "username": "zhangsan",
        "user_code": "2024001",
        "email": "zhangsan@example.com",
        "real_name": "张三",
        "role": "student",
        "status": true,
        "created_at": "2024-12-03T10:00:00Z"
    }
}
```

#### 2. 用户登录
```http
POST /api/v1/auth/login
Content-Type: application/json

{
    "login_identifier": "zhangsan@example.com",
    "password": "password123"
}
```

**响应示例：**
```json
{
    "message": "登录成功",
    "user": {
        "id": 1,
        "username": "zhangsan",
        "real_name": "张三",
        "role": "student"
    }
}
```

#### 3. 用户登出
```http
POST /api/v1/auth/logout
```

#### 4. 获取当前用户信息
```http
GET /api/v1/auth/profile
```

#### 5. 修改密码
```http
POST /api/v1/auth/change-password
Content-Type: application/json

{
    "old_password": "oldpassword",
    "new_password": "newpassword123",
    "confirm_password": "newpassword123"
}
```

#### 6. 检查登录状态
```http
GET /api/v1/auth/status
```

### 用户管理接口（管理员功能）

#### 1. 获取用户列表
```http
GET /api/v1/users?page=1&per_page=20&role=student&search=张三
```

#### 2. 获取用户统计
```http
GET /api/v1/users/stats
```

#### 3. 获取指定用户信息
```http
GET /api/v1/users/1
```

#### 4. 更新用户信息
```http
PUT /api/v1/users/1
Content-Type: application/json

{
    "real_name": "张三三",
    "phone": "13900139000"
}
```

#### 5. 停用用户账户
```http
POST /api/v1/users/1/deactivate
```

#### 6. 激活用户账户
```http
POST /api/v1/users/1/activate
```

## 权限装饰器使用

### 基本装饰器

```python
from app.utils.auth_decorators import (
    login_required, admin_required, teacher_required, 
    student_required, teacher_or_admin_required,
    permission_required, owner_or_admin_required
)

# 要求用户登录
@login_required
def some_protected_function():
    pass

# 要求管理员权限
@admin_required
def admin_only_function():
    pass

# 要求教师权限
@teacher_required
def teacher_only_function():
    pass

# 要求教师或管理员权限
@teacher_or_admin_required
def teacher_or_admin_function():
    pass

# 要求特定权限
@permission_required('material:create')
def create_material():
    pass
```

### 资源所有者权限控制

```python
def get_material_owner_id(**kwargs):
    """获取资料所有者ID"""
    material_id = kwargs.get('material_id')
    material = Material.query.get(material_id)
    return material.uploader_id if material else None

@owner_or_admin_required(get_material_owner_id)
def update_material(material_id):
    """只有资料所有者或管理员可以更新"""
    pass
```

## 前端集成示例

### JavaScript/Vue.js 示例

```javascript
// 用户登录
async function login(loginData) {
    try {
        const response = await fetch('/api/v1/auth/login', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'include', // 重要：包含cookies
            body: JSON.stringify(loginData)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            console.log('登录成功:', result);
            // 登录成功后的处理
            return result;
        } else {
            throw new Error(result.message);
        }
    } catch (error) {
        console.error('登录失败:', error);
        throw error;
    }
}

// 检查登录状态
async function checkLoginStatus() {
    try {
        const response = await fetch('/api/v1/auth/status', {
            credentials: 'include'
        });
        
        const result = await response.json();
        return result.logged_in;
    } catch (error) {
        console.error('检查登录状态失败:', error);
        return false;
    }
}

// 发送需要认证的请求
async function fetchProtectedData() {
    try {
        const response = await fetch('/api/v1/users', {
            credentials: 'include' // 重要：包含session cookie
        });
        
        if (response.status === 401) {
            // 未登录，重定向到登录页
            window.location.href = '/login';
            return;
        }
        
        const data = await response.json();
        return data;
    } catch (error) {
        console.error('请求失败:', error);
    }
}

// 用户登出
async function logout() {
    try {
        const response = await fetch('/api/v1/auth/logout', {
            method: 'POST',
            credentials: 'include'
        });
        
        const result = await response.json();
        console.log('登出成功:', result);
        
        // 清除本地状态并重定向
        window.location.href = '/login';
    } catch (error) {
        console.error('登出失败:', error);
    }
}
```

### Vue.js 路由守卫示例

```javascript
// router/index.js
import { createRouter, createWebHistory } from 'vue-router'

const router = createRouter({
    history: createWebHistory(),
    routes: [
        // 路由配置
    ]
})

// 全局前置守卫
router.beforeEach(async (to, from, next) => {
    // 检查是否需要认证
    if (to.meta.requiresAuth) {
        const isLoggedIn = await checkLoginStatus();
        
        if (!isLoggedIn) {
            next('/login');
            return;
        }
        
        // 检查角色权限
        if (to.meta.roles) {
            const userRole = await getCurrentUserRole();
            if (!to.meta.roles.includes(userRole)) {
                next('/403'); // 权限不足页面
                return;
            }
        }
    }
    
    next();
});
```

## 错误处理

### 常见错误代码

| 错误代码 | HTTP状态码 | 描述 | 处理建议 |
|----------|------------|------|----------|
| `UNAUTHORIZED` | 401 | 用户未登录 | 重定向到登录页 |
| `INSUFFICIENT_PERMISSIONS` | 403 | 权限不足 | 显示权限不足提示 |
| `USER_NOT_FOUND` | 404 | 用户不存在 | 检查用户ID是否正确 |
| `REGISTRATION_FAILED` | 400 | 注册失败 | 检查注册信息是否有效 |
| `LOGIN_FAILED` | 401 | 登录失败 | 检查用户名密码是否正确 |
| `INVALID_PASSWORD` | 400 | 密码错误 | 提示用户重新输入 |

### 错误处理示例

```javascript
// 统一错误处理函数
function handleApiError(error, response) {
    const errorCode = response?.error_code;
    
    switch (errorCode) {
        case 'UNAUTHORIZED':
            // 清除本地状态，重定向到登录页
            localStorage.clear();
            window.location.href = '/login';
            break;
            
        case 'INSUFFICIENT_PERMISSIONS':
            // 显示权限不足提示
            showMessage('权限不足，无法执行此操作', 'error');
            break;
            
        case 'USER_NOT_FOUND':
            showMessage('用户不存在', 'error');
            break;
            
        default:
            showMessage(response?.message || '操作失败', 'error');
    }
}
```

## 安全最佳实践

### 1. 密码安全
- 使用强密码策略（最少6位，包含字母数字）
- 密码使用Werkzeug安全哈希存储
- 支持密码修改功能

### 2. Session安全
- 设置合理的Session过期时间
- 使用HttpOnly Cookie防止XSS攻击
- 在生产环境启用Secure Cookie

### 3. 权限控制
- 最小权限原则：用户只拥有必要的权限
- 资源级权限控制：确保用户只能访问自己的资源
- 定期审核用户权限

### 4. API安全
- 所有敏感操作都需要认证
- 使用装饰器统一权限控制
- 记录用户操作日志

## 部署配置

### 生产环境配置

```python
# config.py
class ProductionConfig(Config):
    DEBUG = False
    
    # Session安全配置
    SESSION_COOKIE_SECURE = True  # 只在HTTPS下传输
    SESSION_COOKIE_HTTPONLY = True
    SESSION_COOKIE_SAMESITE = 'Strict'
    
    # 使用强密钥
    SECRET_KEY = os.environ.get('SECRET_KEY')  # 从环境变量获取
```

### 环境变量设置

```bash
# .env
SECRET_KEY=your-very-secure-secret-key-here
DATABASE_URL=postgresql://user:password@localhost/eduinsight
CORS_ORIGINS=https://yourdomain.com
```

## 总结

本用户认证与权限管理系统提供了完整的多角色认证功能，支持：

✅ **完整的用户生命周期管理**：注册、登录、权限控制、账户管理  
✅ **灵活的权限系统**：基于角色的权限控制和资源级权限验证  
✅ **安全的认证机制**：Session-based认证，密码加密存储  
✅ **易于集成**：提供完整的API接口和装饰器  
✅ **生产就绪**：包含安全配置和错误处理

系统已准备好用于教师智能助手系统的用户认证与权限管理需求。
