# 数据模型修正说明

## 修正概述

根据 `backend/docs/数据库表结构设计.md` 对 `docs/开发需求文档.md` 中的数据模型进行了全面修正，确保两个文档的数据库表结构完全一致。

---

## 修正详情

### 1. 用户表 (User)

**修正内容**:
- ✅ 添加 `user_code` 字段 - 工号/学号(唯一)
- ✅ 添加 `phone` 字段 - 手机号
- ✅ 添加 `avatar` 字段 - 头像URL
- ✅ 添加 `class_id` 字段 - 班级ID(学生角色时使用)
- ✅ 添加 `status` 字段 - 账号状态(1:正常, 0:禁用)
- ✅ 添加 `last_login_time` 字段 - 最后登录时间
- ✅ 修正时间字段命名: `created_at/updated_at` → `create_time/update_time`
- ✅ 明确 `email` 为唯一约束

---

### 2. 资料中心模块

#### 2.1 Material (资料表)

**修正内容**:
- ✅ 添加 `file_name` 字段 - 原始文件名
- ✅ 修正字段名: `tags` → 删除(改用关联表)
- ✅ 修正字段名: `category` → `category_id` (外键)
- ✅ 添加 `view_count` 字段 - 浏览次数
- ✅ 添加 `keywords` 字段 - 关键词(逗号分隔,用于智能归类)
- ✅ 添加 `auto_classified` 字段 - 是否自动分类
- ✅ 修正时间字段命名

**新增表**:
- ✅ `MaterialCategory` - 资料分类表(支持多级分类)
- ✅ `MaterialTag` - 资料标签表
- ✅ `MaterialTagRelation` - 资料标签关联表(多对多)

#### 2.2 Course (课程表)

**修正内容**:
- ✅ 添加 `academic_year` 字段 - 学年
- ✅ 添加 `credit` 字段 - 学分
- ✅ 添加 `total_hours` 字段 - 总学时
- ✅ 添加 `status` 字段 - 课程状态
- ✅ 明确 `code` 为唯一约束
- ✅ 修正时间字段命名

**新增表**:
- ✅ `Class` - 班级表
- ✅ `CourseClasses` - 课程班级关联表(多对多)

---

### 3. 考勤管理模块

#### 3.1 Attendance (考勤任务表)

**修正内容**:
- ✅ 添加 `class_id` 字段 - 班级ID(可选)
- ✅ 添加 `attendance_type` 字段 - 考勤方式(qrcode/manual/face)
- ✅ 添加 `location` 字段 - 考勤地点
- ✅ 添加 `require_location` 字段 - 是否需要位置验证
- ✅ 修正状态值: `active/closed` → `pending/active/ended`
- ✅ 修正时间字段命名

#### 3.2 AttendanceRecord (考勤记录表)

**修正内容**:
- ✅ 添加 `check_in_method` 字段 - 签到方式
- ✅ 添加 `latitude` 字段 - 签到纬度
- ✅ 添加 `longitude` 字段 - 签到经度
- ✅ 添加 `face_image_path` 字段 - 人脸识别照片路径
- ✅ 添加 `remark` 字段 - 备注
- ✅ 修正状态值: 添加 `leave` (请假)
- ✅ 删除 `ip_address` 字段
- ✅ 删除 `location` 字段(改用经纬度)
- ✅ 修正时间字段命名

**新增表**:
- ✅ `AttendanceStatistics` - 考勤统计表

---

### 4. 成绩管理模块

#### 4.1 Grade (成绩表)

**修正内容**:
- ✅ 修正考试类型值: `平时/期中/期末` → `daily/midterm/final/homework`
- ✅ 添加 `exam_name` 字段 - 考试名称
- ✅ 添加 `weight` 字段 - 权重(用于计算总评)
- ✅ 添加 `exam_date` 字段 - 考试日期
- ✅ 删除 `percentage` 字段
- ✅ 删除 `rank` 字段
- ✅ 删除 `teacher_id` 字段
- ✅ 修正时间字段命名

#### 4.2 GradeStatistics (成绩统计表)

**修正内容**:
- ✅ 添加 `exam_name` 字段 - 考试名称
- ✅ 添加 `total_students` 字段 - 总人数
- ✅ 添加 `median_score` 字段 - 中位数
- ✅ 添加 `score_distribution` 字段 - 分数段分布(JSON格式)
- ✅ 修正字段名: `avg_score` → `average_score`
- ✅ 修正字段名: `max_score` → `highest_score`
- ✅ 修正字段名: `min_score` → `lowest_score`
- ✅ 修正字段名: `std_dev` → `std_deviation`
- ✅ 修正字段名: `calculated_at` → `create_time/update_time`

---

### 5. 课堂互动模块

#### 5.1 Poll (投票表)

**修正内容**:
- ✅ 添加 `description` 字段 - 投票描述
- ✅ 添加 `poll_type` 字段 - 投票类型(single/multiple)
- ✅ 删除 `is_multiple` 字段(合并到poll_type)
- ✅ 修正状态值: `active/closed` → `active/ended`
- ✅ 修正时间字段命名

#### 5.2 PollVote → PollResponse (投票响应表)

**修正内容**:
- ✅ 修正表名: `PollVote` → `PollResponse`
- ✅ 修正字段名: `voted_at` → `create_time`
- ✅ 添加 `update_time` 字段

#### 5.3 Question (提问表)

**修正内容**:
- ✅ 修正字段名: `student_id` → `user_id` (提问者可以是任何角色)
- ✅ 添加 `like_count` 字段 - 点赞数
- ✅ 修正时间字段命名

#### 5.4 Answer → QuestionAnswer (回答表)

**修正内容**:
- ✅ 修正表名: `Answer` → `QuestionAnswer`
- ✅ 修正字段名: `teacher_id` → `user_id` (回答者可以是任何角色)
- ✅ 添加 `is_accepted` 字段 - 是否被采纳
- ✅ 添加 `like_count` 字段 - 点赞数
- ✅ 修正时间字段命名

#### 5.5 Barrage (弹幕表)

**修正内容**:
- ✅ 添加 `is_anonymous` 字段 - 是否匿名
- ✅ 添加 `status` 字段 - 状态(1:正常, 0:已删除)
- ✅ 修正时间字段命名

---

### 6. 智能模块

#### 6.1 资料自动归类

**修正内容**:
- ✅ 删除 `MaterialClassification` 表
- ✅ 新增 `DocumentKeyword` 表 - 文档关键词表
  - 存储提取的关键词及其权重
  - 支持多种提取方法(TF-IDF/TextRank/BERT等)
- ✅ 新增 `ClassificationLog` 表 - 分类日志表
  - 记录自动分类的过程和结果
  - 支持接受/拒绝建议

#### 6.2 学情预警与预测

**修正内容**:
- ✅ 修正表名: `StudentPrediction` → `GradePrediction`
- ✅ 添加 `is_warning` 字段 - 是否预警
- ✅ 添加 `prediction_date` 字段 - 预测日期
- ✅ 添加 `model_version` 字段 - 模型版本
- ✅ 修正字段名: `features` → `features_used`
- ✅ 修正字段名: `suggestions` → `recommendation`
- ✅ 修正字段名: `predicted_at` → `create_time`
- ✅ 删除 `StudentWarning` 表(改用Notification表)
- ✅ 新增 `Notification` 表 - 通知表
  - 统一管理所有类型的通知和预警

---

## 新增的数据表

根据数据库表结构设计文档，以下表在开发需求文档中已补充：

1. **Class** - 班级表
2. **MaterialCategory** - 资料分类表
3. **MaterialTag** - 资料标签表
4. **MaterialTagRelation** - 资料标签关联表
5. **CourseClasses** - 课程班级关联表
6. **AttendanceStatistics** - 考勤统计表
7. **DocumentKeyword** - 文档关键词表
8. **ClassificationLog** - 分类日志表
9. **Notification** - 通知表

---

## 字段命名规范统一

### 时间字段
- ❌ 旧命名: `created_at`, `updated_at`, `voted_at`, `calculated_at`
- ✅ 新命名: `create_time`, `update_time`

### 外键字段
- ✅ 统一使用 `_id` 后缀
- ✅ 明确外键关系和约束

### 状态字段
- ✅ 使用统一的状态值
- ✅ 布尔型状态使用 TINYINT(1:是, 0:否)
- ✅ 枚举型状态使用 VARCHAR

---

## 功能影响分析

### 1. 用户注册功能
**影响**: 需要添加 `user_code` 字段的处理
- 注册时必须提供工号/学号
- 需要验证 `user_code` 的唯一性

### 2. 资料管理功能
**影响**: 标签和分类的处理方式改变
- 标签改为多对多关系，需要通过关联表管理
- 分类改为外键关系，支持多级分类
- 需要实现智能归类的关键词提取和分类日志

### 3. 考勤功能
**影响**: 支持更多考勤方式
- 需要实现人脸识别签到
- 需要实现位置验证
- 需要实现考勤统计功能

### 4. 成绩管理功能
**影响**: 成绩类型和统计方式改变
- 考试类型使用英文标识
- 需要支持权重计算
- 统计数据更加丰富(中位数、分数段分布等)

### 5. 课堂互动功能
**影响**: 表名和字段调整
- 投票响应表改名
- 问题和回答支持点赞功能
- 支持采纳最佳答案

### 6. 智能模块功能
**影响**: 数据结构重新设计
- 关键词提取独立存储
- 分类日志记录完整过程
- 预警通知统一管理

---

## API接口影响

### 需要新增的接口

#### 班级管理
- GET /api/classes - 获取班级列表
- POST /api/classes - 创建班级
- GET /api/classes/{id} - 获取班级详情
- PUT /api/classes/{id} - 更新班级信息

#### 资料分类管理
- GET /api/material-categories - 获取分类列表(支持树形结构)
- POST /api/material-categories - 创建分类
- PUT /api/material-categories/{id} - 更新分类
- DELETE /api/material-categories/{id} - 删除分类

#### 资料标签管理
- GET /api/material-tags - 获取标签列表
- POST /api/material-tags - 创建标签
- POST /api/materials/{id}/tags - 为资料添加标签
- DELETE /api/materials/{id}/tags/{tag_id} - 删除资料标签

#### 考勤统计
- GET /api/attendance/statistics/course/{course_id} - 获取课程考勤统计
- GET /api/attendance/statistics/student/{student_id} - 获取学生考勤统计

#### 通知管理
- GET /api/notifications - 获取通知列表
- PUT /api/notifications/{id}/read - 标记通知为已读
- DELETE /api/notifications/{id} - 删除通知

### 需要修改的接口

#### 用户注册
- 请求体需要添加 `user_code` 字段
- 响应体需要包含更多用户信息

#### 资料上传
- 响应体需要包含智能分类建议
- 需要触发关键词提取

#### 成绩录入
- 请求体需要添加 `exam_name`, `weight`, `exam_date` 字段
- 需要触发成绩统计更新

#### 投票相关
- 表名变更影响API路径
- 响应体字段调整

---

## 数据库迁移建议

### 1. 创建新表
```sql
-- 按照数据库表结构设计文档创建所有新表
-- 包括: classes, material_categories, material_tags等
```

### 2. 修改现有表
```sql
-- 添加缺失字段
ALTER TABLE users ADD COLUMN user_code VARCHAR(50) UNIQUE NOT NULL;
ALTER TABLE users ADD COLUMN phone VARCHAR(20);
-- ... 其他字段

-- 重命名字段
ALTER TABLE users CHANGE created_at create_time DATETIME;
-- ... 其他字段
```

### 3. 数据迁移
```sql
-- 如果有旧数据，需要进行数据迁移
-- 例如: 将旧的tags JSON字段迁移到关联表
```

### 4. 创建索引
```sql
-- 根据数据库表结构设计文档创建所有必要的索引
CREATE INDEX idx_user_code ON users(user_code);
-- ... 其他索引
```

---

## 后续工作建议

### 1. 更新ORM模型
- 根据新的表结构更新所有SQLAlchemy模型
- 添加关系定义(relationship)
- 更新模型方法

### 2. 更新API实现
- 实现新增的API接口
- 修改现有API接口
- 更新API文档

### 3. 更新前端代码
- 修改API调用
- 更新数据模型
- 调整UI组件

### 4. 数据库迁移脚本
- 使用Flask-Migrate创建迁移脚本
- 测试迁移脚本
- 准备回滚方案

### 5. 测试
- 单元测试
- 集成测试
- 数据迁移测试

---

## 总结

本次修正确保了开发需求文档与数据库表结构设计文档的完全一致，主要改进包括：

1. ✅ **字段完整性**: 补充了所有缺失的字段
2. ✅ **命名规范**: 统一了字段命名规范
3. ✅ **关系完整**: 明确了所有表之间的关系
4. ✅ **功能支持**: 数据结构支持所有计划的功能
5. ✅ **扩展性**: 设计支持未来功能扩展

所有修改都已在 `docs/开发需求文档.md` 中完成，可以作为开发的标准参考文档。

---

**文档版本**: v1.0  
**修正日期**: 2024-12-03  
**修正人**: AI Assistant
