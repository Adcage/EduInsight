# 数据库模型创建总结

## 完成概览

已按照《模型类与Schema定义规范》完成所有24个数据库表的模型定义。

---

## 已创建的模型文件

### 1. 用户与权限模块 (1个表)

**文件**: `app/models/user.py` (已存在)
- ✅ `User` - 用户模型
- ✅ `UserRole` - 用户角色枚举

### 2. 班级模块 (1个表)

**文件**: `app/models/class_model.py` (已存在)
- ✅ `Class` - 班级模型

### 3. 资料中心模块 (4个表)

**文件**: `app/models/material.py` ⭐ 新创建
- ✅ `Material` - 资料模型
- ✅ `MaterialCategory` - 资料分类模型
- ✅ `MaterialTag` - 资料标签模型
- ✅ `material_tag_relation` - 资料标签关联表

**主要功能**:
- 支持多级分类
- 多对多标签关系
- 下载/浏览统计
- 智能归类支持

### 4. 课程模块 (2个表)

**文件**: `app/models/course.py` ⭐ 新创建
- ✅ `Course` - 课程模型
- ✅ `course_classes` - 课程班级关联表

**主要功能**:
- 课程与班级多对多关系
- 学期和学年管理
- 学分和学时记录

### 5. 考勤管理模块 (3个表)

**文件**: `app/models/attendance.py` ⭐ 新创建
- ✅ `Attendance` - 考勤任务模型
- ✅ `AttendanceRecord` - 考勤记录模型
- ✅ `AttendanceStatistics` - 考勤统计模型
- ✅ `AttendanceType` - 考勤方式枚举
- ✅ `AttendanceStatus` - 考勤状态枚举
- ✅ `CheckInStatus` - 签到状态枚举

**主要功能**:
- 多种签到方式(二维码/手动/人脸识别)
- 位置验证支持
- 自动统计考勤率

### 6. 成绩管理模块 (3个表)

**文件**: `app/models/grade.py` ⭐ 新创建
- ✅ `Grade` - 成绩模型
- ✅ `GradeStatistics` - 成绩统计模型
- ✅ `GradePrediction` - 成绩预测模型
- ✅ `ExamType` - 考试类型枚举
- ✅ `RiskLevel` - 风险等级枚举

**主要功能**:
- 多种考试类型
- 权重计算
- 自动统计分析(平均分、标准差、分数段分布等)
- 成绩预测和预警

### 7. 课堂互动模块 (5个表)

**文件**: `app/models/interaction.py` ⭐ 新创建
- ✅ `Poll` - 投票模型
- ✅ `PollResponse` - 投票响应模型
- ✅ `Question` - 提问模型
- ✅ `QuestionAnswer` - 回答模型
- ✅ `Barrage` - 弹幕模型
- ✅ `PollType` - 投票类型枚举
- ✅ `PollStatus` - 投票状态枚举
- ✅ `QuestionStatus` - 问题状态枚举

**主要功能**:
- 单选/多选投票
- 匿名支持
- 问答点赞和采纳
- 弹幕软删除

### 8. 智能模块 (2个表)

**文件**: `app/models/intelligence.py` ⭐ 新创建
- ✅ `DocumentKeyword` - 文档关键词模型
- ✅ `ClassificationLog` - 分类日志模型

**主要功能**:
- 关键词提取和权重
- 自动分类日志
- 分类建议接受/拒绝
- 准确率统计

### 9. 系统日志模块 (2个表)

**文件**: `app/models/system.py` ⭐ 新创建
- ✅ `SystemLog` - 系统日志模型
- ✅ `Notification` - 通知模型
- ✅ `NotificationType` - 通知类型枚举
- ✅ `NotificationPriority` - 通知优先级枚举

**主要功能**:
- 操作日志记录
- 多类型通知
- 优先级管理
- 已读/未读状态

---

## 模型统计

| 模块 | 模型数量 | 枚举数量 | 关联表数量 |
|------|---------|---------|-----------|
| 用户与权限 | 1 | 1 | 0 |
| 班级 | 1 | 0 | 0 |
| 资料中心 | 3 | 0 | 1 |
| 课程 | 1 | 0 | 1 |
| 考勤管理 | 3 | 3 | 0 |
| 成绩管理 | 3 | 2 | 0 |
| 课堂互动 | 5 | 3 | 0 |
| 智能模块 | 2 | 0 | 0 |
| 系统日志 | 2 | 2 | 0 |
| **总计** | **21** | **11** | **2** |

---

## 规范遵循情况

### ✅ 完全遵循的规范

1. **继承BaseModel**
   - 所有模型都继承自 `BaseModel`
   - 自动获得 `id`, `created_at`, `updated_at` 字段
   - 自动获得 `to_dict()`, `save()`, `delete()` 等方法

2. **字段定义规范**
   - 字段按类型分组并添加注释
   - 外键字段只用注释标记 `# FK→table.id`
   - 使用枚举类型而非字符串常量
   - 合理使用索引

3. **关系定义规范**
   - 正确配置 `lazy` 参数
   - 正确配置 `cascade` 参数
   - 使用 `backref` 建立反向引用

4. **方法定义规范**
   - 实例方法: 业务逻辑、状态判断
   - 类方法: 查询方法
   - 魔术方法: `__repr__()`

5. **命名规范**
   - 模型类: 单数名词 (User, Material)
   - 枚举类: 单数名词 (UserRole, ExamType)
   - 关联表: 复数_复数 (material_tag_relation, course_classes)
   - 字段: snake_case
   - 方法: snake_case

6. **文档字符串**
   - 所有模型都有类文档字符串
   - 所有方法都有文档字符串

---

## 关键设计决策

### 1. 外键约束处理
- **决策**: 不使用 SQLAlchemy 的 `ForeignKey` 约束
- **原因**: 避免创建表时的依赖问题
- **实现**: 使用注释标记外键关系 `# FK→table.id`

### 2. 枚举类型使用
- **决策**: 使用 Python Enum + SQLAlchemy Enum
- **优势**: 
  - 类型安全
  - 代码可读性高
  - IDE 自动补全

### 3. 软删除 vs 硬删除
- **Barrage**: 使用软删除 (status字段)
- **其他**: 使用硬删除 (cascade)
- **原因**: 弹幕可能需要审核和恢复

### 4. 统计数据处理
- **AttendanceStatistics**: 独立统计表
- **GradeStatistics**: 独立统计表
- **优势**: 
  - 提高查询性能
  - 支持历史数据分析
  - 减少实时计算压力

---

## 关系图

### 核心关系

```
User (用户)
  ├── 1:N → Material (上传的资料)
  ├── 1:N → Course (教授的课程)
  ├── 1:N → Attendance (创建的考勤)
  ├── 1:N → AttendanceRecord (签到记录)
  ├── 1:N → Grade (成绩记录)
  ├── 1:N → Poll (创建的投票)
  ├── 1:N → Question (提出的问题)
  └── 1:N → Notification (接收的通知)

Course (课程)
  ├── N:M → Class (通过 course_classes)
  ├── 1:N → Material (课程资料)
  ├── 1:N → Attendance (课程考勤)
  ├── 1:N → Grade (课程成绩)
  ├── 1:N → Poll (课程投票)
  └── 1:N → Question (课程提问)

Material (资料)
  ├── N:1 → MaterialCategory (分类)
  ├── N:M → MaterialTag (通过 material_tag_relation)
  ├── 1:N → DocumentKeyword (关键词)
  └── 1:N → ClassificationLog (分类日志)
```

---

## 下一步工作

### 1. 数据库迁移
```bash
# 初始化迁移
flask db init

# 创建迁移脚本
flask db migrate -m "Initial migration"

# 执行迁移
flask db upgrade
```

### 2. 创建Schema类
- 为每个模型创建对应的 Pydantic Schema
- 参考 `user_schemas.py` 的结构
- 包括: Request, Response, Query, Path 等Schema

### 3. 创建Service层
- 为每个模块创建Service类
- 实现业务逻辑
- 参考 `user_service.py` 的结构

### 4. 创建API层
- 为每个模块创建API Blueprint
- 使用 Flask-OpenAPI3 装饰器
- 参考 `auth_api.py` 的结构

### 5. 测试
- 单元测试: 测试模型方法
- 集成测试: 测试模型关系
- 性能测试: 测试查询效率

---

## 注意事项

### 1. 导入循环问题
- 某些模型之间存在相互引用
- 使用字符串形式的模型名避免循环导入
- 例如: `backref='course'` 而不是 `backref=Course`

### 2. JSON字段兼容性
- MySQL 5.7+ 支持原生 JSON 类型
- SQLite 需要使用 TEXT 存储
- 考虑使用 `db.JSON` 或 `db.Text`

### 3. 时间字段
- 统一使用 UTC 时间
- 前端显示时转换为本地时间
- 使用 `datetime.utcnow()` 而不是 `datetime.now()`

### 4. 索引优化
- 外键字段已添加索引
- 常用查询字段已添加索引
- 后续根据实际查询性能调整

---

## 文件清单

```
backend/app/models/
├── __init__.py           ✅ 已更新 - 导出所有模型
├── base.py              ✅ 已存在 - 基础模型
├── user.py              ✅ 已存在 - 用户模型
├── class_model.py       ✅ 已存在 - 班级模型
├── material.py          ⭐ 新创建 - 资料中心模块
├── course.py            ⭐ 新创建 - 课程模块
├── attendance.py        ⭐ 新创建 - 考勤管理模块
├── grade.py             ⭐ 新创建 - 成绩管理模块
├── interaction.py       ⭐ 新创建 - 课堂互动模块
├── intelligence.py      ⭐ 新创建 - 智能模块
└── system.py            ⭐ 新创建 - 系统日志模块
```

---

**创建日期**: 2024-12-03  
**创建者**: AI Assistant  
**状态**: ✅ 全部完成
